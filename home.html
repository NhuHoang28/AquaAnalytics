<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giam sat chat luong nuoc</title>
    <link rel="stylesheet" href="./assets/fonts/themify-icons/themify-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/themes/base/jquery-ui.min.css">
    <script src="Chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
</head>
<body>
    <div
    style="
        background-color: #20bbda; 
        display: flex; 
        justify-content: space-between; 
        padding: 0 50px;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
    ">
    <p 
        style="
        cursor: pointer; 
        display: inline-block;
        font-size: 30px;
        font-weight: bold;
        margin:0;
        display: flex;
        align-items: center;
        "
    >
        Aqua analytics
    </p>
    <div style="margin:0px 100px ;cursor: pointer; display: inline-block; font-size: 19px;">
        <p style="cursor: pointer; display: inline-block; margin: 13px 0 13px 20px;" id="trangchu">
            Trang chủ
        </p>
        <p style="cursor: pointer; display: inline-block;margin: 13px 0 13px 20px;" id="dulieu">
            Dữ liệu
        </p>
        <p style="cursor: pointer; display: inline-block;margin: 13px 0 13px 20px;" id="giamsat">
            Giám sát
        </p>
        <p style="cursor: pointer; display: inline-block;margin: 13px 0 13px 20px;" id="dangxuat">
            Đăng xuất
        </p>
    </div>
</div>
<script>
    const btn1 = document.querySelector("#trangchu");
    btn1.addEventListener("click", (e) => {
    e.preventDefault();
        window.location.href = "index.html";
    });
    const btn2 = document.querySelector("#dulieu");
    btn2.addEventListener("click", (e) => {
    e.preventDefault();
        window.location.href = "home.html";
    });
    const btn3= document.querySelector("#giamsat");
    btn3.addEventListener("click", (e) => {
    e.preventDefault();
        window.location.href = "home.html";
    });
    const btn4 = document.querySelector("#dangxuat");
    btn4.addEventListener("click", (e) => {
    e.preventDefault();
        window.location.href = "login.html";
    });
</script>
    <div style="padding-top: 70px; display: flex;" >
        <div style="width: 30%; border: 1px solid black;">
                <p style="margin: 0; padding: 10px 5px; background-color: #b0f2ff; border-bottom: 1px solid black;">Thông số hiện tại:</p>
                <div style="display: flex; justify-content: space-around; padding: 10px 10px 20px 10px; border-bottom: 1px solid black;">
                    <div>
                        <p style="display: inline-block; font-weight: bold;">DO =</p>
                        <p id="DO" style="display: inline-block;"></p>
                    </div>
                    <div>
                        <p style="display: inline-block; font-weight: bold;"> ORP =</p>
                        <p id="ORP" style="display: inline-block;"></p>
                    </div>
                    <div>
                        <p style="display: inline-block; font-weight: bold;">T =</p>
                        <p id="T" style="display: inline-block;"></p>
                    </div>
                </div>
            <p style="margin: 0; padding: 10px 5px; background-color: #b0f2ff; border-bottom: 1px solid black;">Điểm thu:</p>
            <div  style="padding: 10px 10px 20px 10px; border-bottom: 1px solid black;">
                <div>  
                    <p style="display: inline-block; font-weight: bold;">ID ứng dụng:</p>
                    <p  id="app_id" style="display: inline-block;"></p>
                </div>
                <div>
                    <p style="display: inline-block; font-weight: bold;">ID thiết bị:</p>
                    <p  id="dev_id" style="display: inline-block;"></p>
                </div>
            </div>
            <p style="margin: 0; padding: 10px 5px; background-color: #b0f2ff; border-bottom: 1px solid black;">Thông số truyền:</p>
            <div style="padding: 10px 10px 20px 10px;display: flex; justify-content: space-around">
                <div>  
                    <p style="display: inline-block; font-weight: bold;">RSSI=</p>
                    <p id="rssi" style="display: inline-block;"></p>
                </div>
                <div>
                    <p style="display: inline-block; font-weight: bold;">SRN=</p>
                    <p id="srn" style="display: inline-block;"></p>
                </div>
                <div>
                    <p style="display: inline-block; font-weight: bold;">SF=</p>
                    <p  id="spreading_factor" style="display: inline-block;"></p>
                </div>
            </div>
        </div>
    
        <div>
            <div style=" margin-left: 10px;border: 1px solid black;" >

                <p  style="margin: 0; padding: 10px 5px; background-color: #b0f2ff; border-bottom: 1px solid black;">BIỂU ĐỒ THÔNG SỐ "DO"</p>
                <div style="border-bottom: 1px solid black; padding: 10px 0 20px 0;" class="contain-C">
                    <canvas id="canvasD" width="800" height="150" style="padding-left: 40px;"></canvas>
                </div>

                <p style="margin: 0; padding: 10px 5px; background-color: #b0f2ff; border-bottom: 1px solid black;">BIỂU ĐỒ THÔNG SỐ "ORP"</p>
                <div style=" border-bottom: 1px solid black;padding-bottom: 10px 0 20px 0;" class="contain-C">
                    <canvas id="canvasO" width="800" height="150" style="padding-left: 40px; "></canvas>
                </div>

                <p style="margin: 0; padding: 10px 5px; background-color: #b0f2ff; border-bottom: 1px solid black;">BIỂU ĐỒ THÔNG SỐ "T"</p>
                <div class="contain-C" style="padding-bottom: 20px 0 0px 0;">
                    <canvas id="canvasT" width="800" height="150" style="padding-left: 40px;"></canvas>
                </div>
               </div>
        </div>
    </div>

    <!-- GET DATA FROM FIREBASE DATABASE -->
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyAEZQE-lRmp8vsYAAv6NMB9gVnTOiRn3fs",
            authDomain: "test-14e86.firebaseapp.com",
            databaseURL: "https://test-14e86-default-rtdb.firebaseio.com",
            projectId: "test-14e86",
            storageBucket: "test-14e86.appspot.com",
            messagingSenderId: "448624890758",
            appId: "1:448624890758:web:91131112cba47044775207"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <script>
        var database = firebase.database();

        var ref = database.ref("/data")

        ref.on("value", function(snapshot) {
            // Lấy dữ liệu
            var data = snapshot.val();
            // Lấy tên các field trong firebase
            allkeys = Object.keys(data);
            // Lấy tên cuối cùng (Nếu tên là thời gian thì đây sẽ là tên của field mới nhất)
            lastRecord = allkeys[allkeys.length - 1];

            var database = firebase.database();
            var ref = database.ref("/data/"+lastRecord+"/end_device_ids/application_ids/application_id");
            ref.once("value", function(snapshot) {
            var app_id = snapshot.val();
            console.log(app_id);
            document.getElementById("app_id").innerHTML=app_id;});

            var database = firebase.database();
            var ref = database.ref("/data/"+lastRecord+"/end_device_ids/device_id");
            ref.once("value", function(snapshot) {
            var dev_id = snapshot.val();
            console.log(dev_id);
            document.getElementById("dev_id").innerHTML=dev_id;});

            var database = firebase.database();
            var ref = database.ref("/data/"+lastRecord+"/uplink_message/rx_metadata/0/rssi");
            ref.once("value", function(snapshot) {
            var rssi = snapshot.val();
            console.log(rssi);
            document.getElementById("rssi").innerHTML=rssi;})

            var database = firebase.database();
            var ref = database.ref("/data/"+lastRecord+"/uplink_message/rx_metadata/0/snr");
            ref.once("value", function(snapshot) {
            var srn = snapshot.val();
            console.log(srn);
            document.getElementById("srn").innerHTML=srn;})

            var database = firebase.database();
            var ref = database.ref("/data/"+lastRecord+"/uplink_message/settings/data_rate/lora/spreading_factor");
            ref.once("value", function(snapshot) {
            var spreading_factor = snapshot.val();
            console.log(spreading_factor);
            document.getElementById("spreading_factor").innerHTML=spreading_factor;})

            var database = firebase.database();
            var ref = database.ref("/data/"+lastRecord+"/uplink_message/decoded_payload/DO");
            ref.once("value", function(snapshot) {
            var DO = snapshot.val();
            console.log(DO);
            document.getElementById("DO").innerHTML=DO;})

            var database = firebase.database();
            var ref = database.ref("/data/"+lastRecord+"/uplink_message/decoded_payload/ORP");
            ref.once("value", function(snapshot) {
            var ORP = snapshot.val();
            console.log(ORP);
            document.getElementById("ORP").innerHTML=ORP;})

            var database = firebase.database();
            var ref = database.ref("/data/"+lastRecord+"/uplink_message/decoded_payload/T");
            ref.once("value", function(snapshot) {
            var T = snapshot.val();
            console.log(T);
            document.getElementById("T").innerHTML=T;})
            
        });

        
    </script>
    <!-- GETTING CLOSE -->
    <script>
        var database = firebase.database();
        var ref = database.ref("/data")
        ref.on("value", function(snapshot) {
            var data = snapshot.val();
            allkeys = Object.keys(data);
            lastRecord = allkeys[allkeys.length - 1];
            
            // Lưu 10 (hoặc toàn bộ nếu số bản ghi ít hơn 10) giá trị cuối cùng (mới nhất) vào mảng records_for_chart
            var records_for_chart = Array()
            for (var i = 0; i < 24 && i < allkeys.length; i++) {
                records_for_chart.push(data[allkeys[allkeys.length - i-1]]);
            }
            
            // Lưu 10 giá trị cuối cùng (mới nhất) vào mảng records_for_chart
            data_for_chart = Array();
            horizontal_data = Array();

            // Giá trị của trục hoành cho đường ngang
            horizontal_data_value = 10;

            // Lấy ra 10 giá trị DO từ mảng records_for_chart
            for (var i = records_for_chart.length - 1; i >= 0; i--) {
                data_for_chart.push(records_for_chart[i]["uplink_message"].decoded_payload.DO);
                horizontal_data.push(horizontal_data_value);
            }
            var lineChartData = {
                labels: ["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00",
                        "08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00",
                        "16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],
                datasets: [{
                        fillColor : "rgba(220,220,220,0.5)",
                        strokeColor : "red",
                        pointColor : "red",
                        pointStrokeColor : "white",
                        data:data_for_chart
                    }, {
                        fillColor : "rgba(220,220,220,0)",
                        strokeColor : "blue",
                        pointColor : "rgba(220,220,220,0)",
                        pointStrokeColor : "rgba(220,220,220,0)",
                        data: horizontal_data,
                    }
                ]
            }
            var myLine = new Chart(document.getElementById("canvasD").getContext("2d")).Line(lineChartData);
            document.getElementById("canvasD").width = 800;
            document.getElementById("canvasD").height = 150;
        });
    </script>
    <script>
        var database = firebase.database();
        var ref = database.ref("/data")
        ref.on("value", function(snapshot) {
            var data = snapshot.val();
            allkeys = Object.keys(data);
            lastRecord = allkeys[allkeys.length - 1];
            
            var records_for_chart = Array()
            for (var i = 0; i < 24 && i < allkeys.length; i++) {
                records_for_chart.push(data[allkeys[allkeys.length - i-1]]);
            }
            
            // Lưu 10 giá trị cuối cùng (mới nhất) vào mảng records_for_chart
            data_for_chart = Array();
            horizontal_data = Array();

            // Giá trị của trục hoành cho đường ngang
            horizontal_data_value = 10;

            // Lấy ra 10 giá trị ORP từ mảng records_for_chart
            for (var i = records_for_chart.length - 1; i >= 0; i--) {
                data_for_chart.push(records_for_chart[i]["uplink_message"].decoded_payload.ORP);
                horizontal_data.push(horizontal_data_value);
            }
            var lineChartData = {
                labels: ["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00",
                        "08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00",
                        "16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],
                datasets: [{
                        fillColor : "rgba(220,220,220,0.5)",
                        strokeColor : "red",
                        pointColor : "red",
                        pointStrokeColor : "white",
                        data:data_for_chart
                    }, {
                        fillColor : "rgba(220,220,220,0)",
                        strokeColor : "blue",
                        pointColor : "rgba(220,220,220,0)",
                        pointStrokeColor : "rgba(220,220,220,0)",
                        data: horizontal_data,
                    }
                ]
            }
            var myLine = new Chart(document.getElementById("canvasO").getContext("2d")).Line(lineChartData);
            document.getElementById("canvasO").width = 800;
            document.getElementById("canvasO").height = 150;
        });
    </script>
    <script>
        var database = firebase.database();
        var ref = database.ref("/data")
        ref.on("value", function(snapshot) {
            var data = snapshot.val();
            allkeys = Object.keys(data);
            lastRecord = allkeys[allkeys.length - 1];
            
            var records_for_chart = Array()
            for (var i = 0; i < 24 && i < allkeys.length; i++) {
                records_for_chart.push(data[allkeys[allkeys.length - i-1]]);
            }
            
            // Lưu 10 giá trị cuối cùng (mới nhất) vào mảng records_for_chart
            data_for_chart = Array();
            horizontal_data = Array();

            // Giá trị của trục hoành cho đường ngang
            horizontal_data_value = 10;

            // Lấy ra 10 giá trị T từ mảng records_for_chart
            for (var i = records_for_chart.length - 1; i >= 0; i--) {
                data_for_chart.push(records_for_chart[i]["uplink_message"].decoded_payload.T);
                horizontal_data.push(horizontal_data_value);
            }
            var lineChartData = {
                labels: ["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00",
                        "08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00",
                        "16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],
                datasets: [{
                        fillColor : "rgba(220,220,220,0.5)",
                        strokeColor : "red",
                        pointColor : "red",
                        pointStrokeColor : "white",
                        data:data_for_chart
                    }, {
                        fillColor : "rgba(220,220,220,0)",
                        strokeColor : "blue",
                        pointColor : "rgba(220,220,220,0)",
                        pointStrokeColor : "rgba(220,220,220,0)",
                        data: horizontal_data,
                    }
                ]
            }
            var myLine = new Chart(document.getElementById("canvasT").getContext("2d")).Line(lineChartData);
            document.getElementById("canvasT").width = 800;
            document.getElementById("canvasT").height = 150;
        });
    </script>
</body>
</html>